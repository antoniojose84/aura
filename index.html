import React, { useState, useEffect } from 'react';

// Importa los m\u00f3dulos necesarios de Firebase
import { initializeApp } from 'firebase/app';
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp } from 'firebase/firestore';

// El c\u00f3digo se ejecuta en un entorno donde estas variables est\u00e1n disponibles
// Son necesarias para conectar la aplicaci\u00f3n a tu base de datos en la nube (Firestore)
const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Aseg\u00farate de que la configuraci\u00f3n de Firebase es v\u00e1lida antes de inicializar la app
if (!firebaseConfig.projectId) {
  console.error("Firebase no est\u00e1 configurado correctamente. Por favor, revisa la configuraci\u00f3n.");
}

// Inicializa la aplicaci\u00f3n de Firebase
const app = firebaseConfig.projectId ? initializeApp(firebaseConfig) : null;
const db = app ? getFirestore(app) : null;
const auth = app ? getAuth(app) : null;

// Componente principal de la aplicaci\u00f3n
const App = () => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [posts, setPosts] = useState([]);
  const [view, setView] = useState('login'); // 'login', 'signup', 'feed'
  const [error, setError] = useState('');

  // Efecto para autenticar al usuario al iniciar la aplicaci\u00f3n
  useEffect(() => {
    if (!auth || !initialAuthToken) {
      setLoading(false);
      return;
    }

    const signIn = async () => {
      try {
        await signInWithCustomToken(auth, initialAuthToken);
      } catch (e) {
        console.error("Error al autenticar con token:", e);
      }
    };
    signIn();

    // Listener para los cambios de estado de autenticaci\u00f3n
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
      setLoading(false);
      if (currentUser) {
        setView('feed');
      }
    });

    return () => unsubscribe();
  }, []);

  // Efecto para escuchar los posts en tiempo real
  useEffect(() => {
    if (!db || !user) return;
    
    // Obtiene los posts de la colecci\u00f3n 'posts' y los actualiza en tiempo real
    const q = query(collection(db, 'posts'));
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const postsData = [];
      snapshot.forEach((doc) => {
        postsData.push({ id: doc.id, ...doc.data() });
      });
      // Ordena los posts por fecha de creaci\u00f3n (el m\u00e1s nuevo primero)
      postsData.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());
      setPosts(postsData);
    }, (err) => {
      console.error("Error al obtener los posts:", err);
      setError("Error al cargar los posts. Int\u00e9ntalo de nuevo.");
    });

    return () => unsubscribe();
  }, [user, db]);

  // Funci\u00f3n para crear una nueva cuenta
  const handleSignUp = async (email, password) => {
    setError('');
    try {
      if (!auth) throw new Error("Servicio de autenticaci\u00f3n no disponible.");
      await createUserWithEmailAndPassword(auth, email, password);
      // El onAuthStateChanged se encargar\u00e1 de actualizar el estado del usuario
    } catch (e) {
      setError('Error al crear la cuenta: ' + e.message);
    }
  };

  // Funci\u00f3n para iniciar sesi\u00f3n
  const handleLogin = async (email, password) => {
    setError('');
    try {
      if (!auth) throw new Error("Servicio de autenticaci\u00f3n no disponible.");
      await signInWithEmailAndPassword(auth, email, password);
      // El onAuthStateChanged se encargar\u00e1 de actualizar el estado del usuario
    } catch (e) {
      setError('Error al iniciar sesi\u00f3n: ' + e.message);
    }
  };

  // Funci\u00f3n para cerrar sesi\u00f3n
  const handleLogout = async () => {
    setError('');
    try {
      if (!auth) throw new Error("Servicio de autenticaci\u00f3n no disponible.");
      await signOut(auth);
      setView('login');
    } catch (e) {
      setError('Error al cerrar sesi\u00f3n: ' + e.message);
    }
  };

  // Muestra la pantalla de carga si a\u00fan se est\u00e1n cargando los datos
  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-100">
        <div className="text-xl font-medium text-gray-700">Cargando...</div>
      </div>
    );
  }

  // Componente del formulario de inicio de sesi\u00f3n
  const LoginForm = () => {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    
    const handleSubmit = (e) => {
      e.preventDefault();
      handleLogin(email, password);
    };

    return (
      <div className="flex flex-col items-center justify-center min-h-screen bg-gray-100 p-4">
        <form onSubmit={handleSubmit} className="w-full max-w-sm bg-white p-8 rounded-lg shadow-md space-y-6">
          <h2 className="text-3xl font-bold text-center text-gray-800">Iniciar Sesi\u00f3n</h2>
          {error && <div className="text-red-500 text-center">{error}</div>}
          <input
            type="email"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            placeholder="Correo electr\u00f3nico"
            required
            className="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
          <input
            type="password"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            placeholder="Contrase\u00f1a"
            required
            className="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
          <button type="submit" className="w-full bg-blue-600 text-white p-3 rounded-md font-semibold hover:bg-blue-700 transition duration-200">
            Entrar
          </button>
          <div className="text-center text-sm text-gray-600 mt-4">
            \u00bfNo tienes una cuenta?{' '}
            <button
              type="button"
              onClick={() => setView('signup')}
              className="text-blue-600 hover:underline font-medium"
            >
              Reg\u00edstrate
            </button>
          </div>
        </form>
      </div>
    );
  };

  // Componente del formulario de registro
  const SignUpForm = () => {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    
    const handleSubmit = (e) => {
      e.preventDefault();
      handleSignUp(email, password);
    };

    return (
      <div className="flex flex-col items-center justify-center min-h-screen bg-gray-100 p-4">
        <form onSubmit={handleSubmit} className="w-full max-w-sm bg-white p-8 rounded-lg shadow-md space-y-6">
          <h2 className="text-3xl font-bold text-center text-gray-800">Crear Cuenta</h2>
          {error && <div className="text-red-500 text-center">{error}</div>}
          <input
            type="email"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            placeholder="Correo electr\u00f3nico"
            required
            className="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
          <input
            type="password"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            placeholder="Contrase\u00f1a"
            required
            className="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
          <button type="submit" className="w-full bg-green-600 text-white p-3 rounded-md font-semibold hover:bg-green-700 transition duration-200">
            Registrarse
          </button>
          <div className="text-center text-sm text-gray-600 mt-4">
            \u00bfYa tienes una cuenta?{' '}
            <button
              type="button"
              onClick={() => setView('login')}
              className="text-green-600 hover:underline font-medium"
            >
              Iniciar Sesi\u00f3n
            </button>
          </div>
        </form>
      </div>
    );
  };

  // Componente del formulario para crear un nuevo post
  const CreatePostForm = () => {
    const [title, setTitle] = useState('');
    const [content, setContent] = useState('');
    const [isPosting, setIsPosting] = useState(false);

    const handleSubmit = async (e) => {
      e.preventDefault();
      if (!db) return;
      setIsPosting(true);
      try {
        const postsCollectionRef = collection(db, 'posts');
        await addDoc(postsCollectionRef, {
          title,
          content,
          authorId: user.uid,
          authorEmail: user.email,
          createdAt: serverTimestamp(),
        });
        setTitle('');
        setContent('');
      } catch (e) {
        console.error("Error al a\u00f1adir el post: ", e);
      }
      setIsPosting(false);
    };

    return (
      <div className="bg-white p-6 rounded-lg shadow-md mb-6">
        <h3 className="text-2xl font-bold mb-4 text-gray-800">Crear un Nuevo Post</h3>
        <form onSubmit={handleSubmit} className="space-y-4">
          <input
            type="text"
            value={title}
            onChange={(e) => setTitle(e.target.value)}
            placeholder="T\u00edtulo del post"
            required
            className="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
          />
          <textarea
            value={content}
            onChange={(e) => setContent(e.target.value)}
            placeholder="\u00bfQu\u00e9 est\u00e1s pensando?"
            required
            rows="4"
            className="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
          ></textarea>
          <button
            type="submit"
            disabled={isPosting}
            className="w-full bg-purple-600 text-white p-3 rounded-md font-semibold hover:bg-purple-700 transition duration-200 disabled:bg-gray-400"
          >
            {isPosting ? 'Publicando...' : 'Publicar'}
          </button>
        </form>
      </div>
    );
  };

  // Componente que muestra el feed (la p\u00e1gina principal de la red social)
  const Feed = () => {
    return (
      <div className="min-h-screen bg-gray-100 p-4 font-sans">
        <header className="flex justify-between items-center bg-white p-6 rounded-lg shadow-md mb-6">
          <h1 className="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-purple-600">
            Mi Red Social
          </h1>
          <button
            onClick={handleLogout}
            className="bg-red-500 text-white font-semibold py-2 px-4 rounded-full shadow-md hover:bg-red-600 transition duration-200"
          >
            Salir
          </button>
        </header>

        <CreatePostForm />

        <main className="space-y-4">
          {posts.length > 0 ? (
            posts.map(post => (
              <div key={post.id} className="bg-white p-6 rounded-lg shadow-md">
                <h4 className="text-xl font-bold text-gray-900 mb-2">{post.title}</h4>
                <p className="text-gray-700 mb-4">{post.content}</p>
                <div className="text-sm text-gray-500">
                  <span className="font-medium">{post.authorEmail}</span> -{' '}
                  {post.createdAt ? new Date(post.createdAt.toDate()).toLocaleString() : 'Fecha desconocida'}
                </div>
              </div>
            ))
          ) : (
            <div className="bg-white p-6 rounded-lg shadow-md text-center text-gray-600">
              A\u00fan no hay publicaciones. \u00a1S\u00e9 el primero en publicar!
            </div>
          )}
        </main>

        <footer className="mt-8 text-center text-gray-500 text-sm">
          <p>\u00a9 2024 Mi Red Social. Todos los derechos reservados.</p>
        </footer>
      </div>
    );
  };

  // Renderiza la vista actual seg\u00fan el estado
  switch (view) {
    case 'signup':
      return <SignUpForm />;
    case 'feed':
      return <Feed />;
    case 'login':
    default:
      return <LoginForm />;
  }
};

export default App;

